# File System & Partition Management Cheatsheet

## üìë Table of Contents

- [MBR Layout](#mbr-layout-for-dd-cmd)
- [List Disks and Partitions](#list-disks-and-partitions)
- [List Partitions on a Specific Disk](#list-partitions-on-a-specific-disk)
- [Edit a Specific Disk](#edit-a-specific-disk)
- [Fdisk Help](#fdisk-help)
- [Create a New Partition](#create-a-new-partition)
- [Change Partition Type](#change-partition-type)
- [Delete a Partition](#delete-a-partition)
- [Print Partition Table Info](#print-partition-table-info)
- [Reload Partition Table Without Reboot](#reload-partition-table-without-reboot)
- [Advanced Topics FYI](#advanced-topics-fyi)
- [GPT Layout](#guid-partition-table-gpt-scheme-breakdown)

---

## MBR Layout for dd CMD


| Offset | Size  | Description        |
| -------- | ------- | -------------------- |
| 0      | 446 B | Boot Code (IPL)    |
| 446    | 64 B  | Partition Table    |
| 510    | 2 B   | Signature (0x55AA) |

### Partition Table Entry (16 Bytes Each)


| Field        | Size | Description               |
| -------------- | ------ | --------------------------- |
| Active       | 1 B  | Bootable flag             |
| Starting CHS | 3 B  | Cylinder-Head-Sector addr |
| Type         | 1 B  | Partition type            |
| Ending CHS   | 3 B  | Cylinder-Head-Sector addr |
| Start Sector | 4 B  | LBA of first sector       |
| Num Sectors  | 4 B  | Number of sectors         |

---

## List Disks and Partitions

**Simple view:**

```bash
lsblk
```

**Detailed view:**

```bash
sudo fdisk -l
```

---

## List Partitions on a Specific Disk

```bash
sudo fdisk -l /dev/<disk_name>   # e.g. sda, nvme0n1
```

---

## Edit a Specific Disk

```bash
sudo fdisk /dev/<disk_name>
```

Follow the interactive instructions.

---

## Fdisk Help

### DOS (MBR)

- `a` ‚Üí toggle bootable flag
- `b` ‚Üí edit nested BSD disklabel
- `c` ‚Üí toggle DOS compatibility flag

### Generic

- `d` ‚Üí delete a partition
- `F` ‚Üí list free space
- `l` ‚Üí list known partition types
- `n` ‚Üí add a new partition
- `p` ‚Üí print partition table
- `t` ‚Üí change partition type
- `v` ‚Üí verify partition table
- `i` ‚Üí print partition details

### Misc

- `m` ‚Üí print help menu
- `u` ‚Üí change units
- `x` ‚Üí expert mode

### Script

- `I` ‚Üí load layout from script file (sfdisk)
- `O` ‚Üí dump layout to script file

### Save & Exit

- `w` ‚Üí write changes to disk and exit
- `q` ‚Üí quit without saving

### Create a New Label

- `g` ‚Üí create empty GPT
- `G` ‚Üí create empty SGI (IRIX)
- `o` ‚Üí create empty MBR (DOS)
- `s` ‚Üí create empty Sun label

---

## Create a New Partition

```bash
sudo fdisk /dev/sda
```

### Primary Partition

```
n ‚Üí p ‚Üí <Start Sector> ‚Üí <End Sector> ‚Üí w
```

### Extended Partition

```
n ‚Üí e ‚Üí <Start Sector> ‚Üí <End Sector> ‚Üí w
```

‚û°Ô∏è Once the extended partition is created, you can add **logical partitions** using:

```
n ‚Üí l
```

**Check extended partition table:**

```bash
sudo dd if=/dev/sda bs=512 count=1 skip=<start_sector> | tail -c 66 | hexdump -C
```

---

## Change Partition Type

```
t ‚Üí <partition_number> ‚Üí <type_code>
```

List available partition types:

```
l
```

üìñ Reference: [Partition type codes](https://en.wikipedia.org/wiki/Partition_type)

---

## Delete a Partition

```
d ‚Üí <partition_number> ‚Üí w
```

---

## Print Partition Table Info

**Read raw partition table (first sector):**

```bash
sudo dd if=/dev/sda bs=512 count=1 | tail -c 66 | hexdump -C
```

- **64B** ‚Üí Partition table
- **2B** ‚Üí Magic number (0x55AA)

---

## Reload Partition Table Without Reboot

After modifying partitions, reload without reboot:

```bash
sudo partprobe      # reload partition table
sudo kpartx -a /dev/sdX   # map partitions
```

---

## Advanced Topics FYI

### Disk Usage & UUIDs

#### Disk Usage

**Check mounted disks usage:**

```bash
df -h
```

- `-h` ‚Üí human-readable (GB/MB)

**Check inode usage:**

```bash
df -i
```

**Check disk usage of a directory:**

```bash
du -sh /path/to/dir
```

- `-s` ‚Üí summary only
- `-h` ‚Üí human-readable

**Top disk space consumers in current dir:**

```bash
du -ah . | sort -rh | head -n 20
```

---

### UUIDs (Universally Unique Identifiers)

**List UUIDs of all partitions:**

```bash
blkid
```

**Check specific device UUID:**

```bash
blkid /dev/sda1
```

**Show UUIDs via lsblk:**

```bash
lsblk -o NAME,UUID
```

**Show UUIDs with file system type:**

```bash
lsblk -f
```

---

### Mounting Using UUIDs

**Temporary mount:**

```bash
sudo mount UUID=<uuid> /mnt/point
```

**Permanent mount (edit fstab):**

```bash
sudo nano /etc/fstab
```

Example line in `/etc/fstab`:

```bash
UUID=<uuid> /mnt/point ext4 defaults 0 2
```

---

## GUID Partition Table (GPT) Scheme Breakdown

Each **LBA (Logical Block Address)** typically represents **512 bytes** (though some disks may use 4096 bytes).
Below is the breakdown of what each LBA is used for in the GPT scheme shown.

---

### LBA Usage

| LBA                     | Size (bytes)         | Purpose                                                                                                                                                                             |
| ------------------------- | ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **LBA 0**               | 512 B                | **Protective MBR** ‚Äî A legacy MBR to protect GPT disks from old tools that only understand MBR. Marks the disk as occupied.                                                        |
| **LBA 1**               | 512 B                | **Primary GPT Header** ‚Äî Contains metadata about GPT, including disk GUID, usable LBAs, number and size of partition entries, and CRC checksums.                                   |
| **LBA 2‚Äì33**           | 32 √ó 512 B = 16 KiB | **Primary Partition Entries** ‚Äî Array of partition entries (usually 128 entries, each 128 bytes). Describes partitions (type GUID, unique GUID, start/end LBAs, attributes, name). |
| **LBA 34‚Äì(n‚àí34)**     | variable             | **Partitions Data Region** ‚Äî Space allocated for partitions (Partition 1, Partition 2, etc.).                                                                                      |
| **LBA (n‚àí33)‚Äì(n‚àí2)** | 32 √ó 512 B = 16 KiB | **Secondary Partition Entries** ‚Äî Backup copy of the partition entries array.                                                                                                      |
| **LBA (n‚àí1)**          | 512 B                | **Secondary GPT Header** ‚Äî Backup copy of GPT header at the end of the disk. Points back to the start.                                                                             |

---

### Model Header (LBA 1)


| Offset | Length   | Contents                                                                                  |
| -------- | ---------- | ------------------------------------------------------------------------------------------- |
| 0x00   | 8 bytes  | **Signature** ‚Äî e.g., "GPT MODEL" identifying the file as a GPT checkpoint               |
| 0x08   | 4 bytes  | **Revision** ‚Äî format revision number (e.g., 0x00010000 for version 1.0)                 |
| 0x0C   | 4 bytes  | **Header Size** ‚Äî size of the header in bytes                                            |
| 0x10   | 4 bytes  | **CRC-32 (Header)** ‚Äî checksum of the header (with this field zeroed during calculation) |
| 0x14   | 4 bytes  | **Reserved** ‚Äî must be zero                                                              |
| 0x18   | 8 bytes  | **Current LBA** ‚Äî location of this header within the file                                |
| 0x20   | 8 bytes  | **Backup LBA** ‚Äî location of a backup header copy (if present)                           |
| 0x28   | 8 bytes  | **First usable block** ‚Äî first block available for model data (after header and tables)  |
| 0x30   | 8 bytes  | **Last usable block** ‚Äî last usable block before extra metadata                          |
| 0x38   | 16 bytes | **Model GUID** ‚Äî unique identifier for this model (UUID)                                 |
| 0x48   | 8 bytes  | **Partition entries start LBA** ‚Äî starting block of the entries array (layers/modules)   |
| 0x50   | 4 bytes  | **Number of entries** ‚Äî number of model units (layers/blocks)                            |
| 0x54   | 4 bytes  | **Entry size** ‚Äî size of each entry in the table (e.g., 128 bytes)                       |
| 0x58   | 4 bytes  | **CRC-32 (entries)** ‚Äî checksum of the entries array                                     |
| 0x5C   | *        | **Reserved** ‚Äî rest of the sector filled with zeroes                                     |

---

### Layer / Module Entries (LBA 2‚ÄìN)

Each entry describes a single model unit (layer, block, embedding, normalization module, etc.).


| Offset | Length   | Contents                                                                             |
| -------- | ---------- | -------------------------------------------------------------------------------------- |
| 0x00   | 16 bytes | **Layer type GUID** ‚Äî identifies the unit type (Attention / MLP / Embedding / Norm) |
| 0x10   | 16 bytes | **Unique layer GUID** ‚Äî unique identifier for this specific unit                    |
| 0x20   | 8 bytes  | **First LBA** ‚Äî starting block of this unit‚Äôs data                                 |
| 0x28   | 8 bytes  | **Last LBA** ‚Äî ending block of this unit‚Äôs data                                    |
| 0x30   | 8 bytes  | **Attributes** ‚Äî flags (e.g., frozen weights, shared weights, trainable)            |
| 0x38   | 72 bytes | **Layer name** ‚Äî human-readable name (UTF-16LE), e.g., "TransformerBlock_12"        |

## Unix Filesystem Structure

This document explains the hierarchical structure of the Unix filesystem, from the initial disk partitioning down to how file data is stored.

### Level 1: The Hard Drive and Partitions

The structure begins at the highest level with the hard drive itself, which is partitioned using the Master Boot Record (MBR).

- **MBR (Master Boot Record)**: The first sector of the hard drive. It contains:

  1. **1st Stage Bootloader**: A small piece of code to initiate the boot process.

  2. **Partition Table**: Describes how the disk is partitioned, holding information for a maximum of four primary partitions.

- **Partitions (P1, P2, P3, P4)**: The main sections into which the disk is divided. Each partition can contain an independent filesystem.

### Level 2: The Internal Structure of a Partition

When a partition (like `P1`) is formatted with a Unix filesystem, it is internally organized into the following components:

1. **Boot Block**

   - The first block of the partition.

   - It contains the **2nd Stage Bootloader**, which is loaded by the MBR.

   - Its function is to understand the filesystem and load the operating system's Kernel.

2. **Super Block**

   - Considered the "ID card" of the filesystem.

   - It contains vital metadata describing the state, size, and layout of the filesystem.

3. **Inode List**

   - A collection of data structures called `Inodes`.

   - **Every file and directory** has a dedicated `Inode` that stores all of its metadata.

4. **Data Blocks**

   - The largest area of the partition.

   - This is where the **actual content** of the files (the data itself) is stored.

### Level 3: Component Details

#### 1. Super Block Contents

The Super Block contains global information about the entire filesystem.

- **Size**: The total size of the filesystem and the number of blocks.

- **Free Blocks**: A list of available blocks that are free to be used for new data.

- **Bad Blocks**: A list of damaged blocks on the disk that the OS should avoid using.

#### 2. Inode Contents

An `Inode` is the file's "ID card." It contains everything about the file **except for its name and its actual content**.

| Field | Description |
|---|---|
| **owner** | The user ID of the file's owner. |
| **group** | The group ID the file belongs to. |
| **type** | The type of file (e.g., regular file, directory, symbolic link). |
| **pmn** | Permissions: Who can read, write, and execute the file. |
| **time** | Timestamps (creation date, last modification, last access). |
| **address** | **Most importantly**: Pointers to the addresses of the Data Blocks that hold the file's actual content. |

#### How It Works

When you open a file, the OS searches through the directory structure to find the file's name and its corresponding `Inode` number. It then reads the `Inode` to get all the metadata and check permissions. Finally, it follows the `address` pointers to locate and read the file's content from the Data Blocks.

- To Know this detaials

```bash
sudo tune2fs -l <partition_name>
```

<u></u>[Virtual File System](https://www.geeksforgeeks.org/operating-systems/virtual-file-system/)
